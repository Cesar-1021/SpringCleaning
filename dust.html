<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recycling</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        canvas {
            display: block;
        }

        #returnButton {
            display: none;
            position: fixed;
            top: 80%;
            left: 50%;
            transform: translate(-50%);
            padding: 2vmin;
            font-size: 5vmin;
            color: white;
            background-color: black;
            border: none;
            border-radius: 3vmin;
            cursor: pointer;
            z-index: 1000;
        }

        #returnButton:hover {
            background-color: pink;
        }
    </style>
</head>

<body>
    <button id="returnButton">Return to Room</button>
    <script>
        var dusterCheck = localStorage.getItem('dusterCheck');

        let shelf;
        let dustBunnyImages = [];
        let dustBunnies = [];

        let duster;
        let dusterSize;
        let dusterDir = 1;
        let dusterAngle = 0;
        let dusterAngleDirection = 1;
        let dusterMaxAngle = 0.3; // max angle for fanning motion
        let dusterAngleSpeed = 0.03; // speed of angle change

        const num = 40;
        let noiseScale = 0.01;
        let radius;
        let bunnySize;

        let scale;
        let width;
        let height;

        // Preload all images
        function preload() {
            shelf = loadImage('sprites/miniGames/shelf.png');
            for (let i = 0; i < num; i++) {
                dustBunnyImages.push(loadImage("sprites/enemies/dustBunny.png"));
            }
            duster = loadImage("sprites/room/dusterIRL.png");
        }

        // setup the vectors of each bunny in the window
        // as well as adjusting the sizes of bunnies, roomba,
        // and radius of suck according to the size of the window
        function setup() {
            frameRate(60);

            scale = Math.min(windowWidth / shelf.width, windowHeight / shelf.height);

            let canvasX = (windowWidth / 2) - (shelf.width / 2) * scale;
            let canvasY = (windowHeight / 2) - (shelf.height / 2) * scale;
            width = shelf.width * scale;
            height = shelf.height * scale;

            canvas = createCanvas(width, height);
            canvas.position(canvasX, canvasY);

            for (let i = 0; i < num; i++) {
                dustBunnies.push(createVector(random(width), random(height)));
            }
            stroke(0, 128, 128);
            noiseSeed(1);
            bunnySize = 150 * scale;
            dusterSize = 200 * scale;
            radius = 350 * scale;
            noiseScale = 0.01 * scale;

            mouseX = windowWidth / 2;
            mouseY = windowHeight / 2;
        }

        function windowResized() {
            scale = Math.min(windowWidth / shelf.width, windowHeight / shelf.height);
            let canvasX = (windowWidth / 2) - (shelf.width / 2) * scale;
            let canvasY = (windowHeight / 2) - (shelf.height / 2) * scale;
            width = shelf.width * scale;
            height = shelf.height * scale;

            resizeCanvas(width, height);
            canvas.position(canvasX, canvasY);

            bunnySize = 150 * scale;
            dusterSize = 200 * scale;
            radius = 350 * scale;
        }

        function draw() {
            background(shelf); // set the background every frame

            // makes the screen look dirty until all dust bunnies are sucked up
            fill(100, 50, 0, 150 * dustBunnies.length / num);
            rect(0, 0, canvas.width, canvas.height);

            if (dusterCheck === '0') {
                for (let i = dustBunnies.length - 1; i >= 0; i--) {
                    let bunny = dustBunnies[i];
                    let bunnyImage = dustBunnyImages[i];
                    let n = noise(bunny.x * noiseScale, bunny.y * noiseScale);
                    let a = TAU * n;
                    let safe;

                    // bunny follows path
                    bunny.x += cos(a);
                    bunny.y += sin(a);

                    image(bunnyImage, bunny.x - bunnySize / 2, bunny.y - bunnySize / 2, bunnySize, bunnySize);

                    // If bunny goes off screen, respawn at a random spot
                    if (!onScreen(bunny)) {
                        bunny.x = random(width);
                        bunny.y = random(height);
                    }
                }
                document.getElementById("returnButton").style.display = "block";

            } else {
                // once every dust bunny has been sucked up, display text to say, "All clean!"
                if (dustBunnies.length < 1) {
                    push();
                    rotate(45);
                    imageMode(CENTER);
                    image(duster, width / 2 + 100 * scale, height / 2 - 950 * scale, duster.width * scale, duster.height * scale);
                    pop();

                    sizeOfText = 180 * scale;
                    textSize(sizeOfText);
                    textStyle(BOLD);
                    textAlign(CENTER);
                    textFont('Papyrus');
                    fill(0);
                    text("All Clean!", width / 2 + 10 * scale, height / 2);
                    text("All Clean!", width / 2 - 10 * scale, height / 2);

                    fill(255);
                    text("All Clean!", width / 2, height / 2);

                    localStorage.setItem('dusterCheck', '2');
                    document.getElementById("returnButton").style.display = "block";

                } else if (mouseIsPressed) {
                    document.getElementById("returnButton").style.display = "none";
                    for (let i = dustBunnies.length - 1; i >= 0; i--) {
                        let bunny = dustBunnies[i];
                        let bunnyImage = dustBunnyImages[i];
                        let n = noise(bunny.x * noiseScale, bunny.y * noiseScale);
                        let a = TAU * n;
                        // bunny in range
                        if (dist(bunny.x, bunny.y, mouseX, mouseY - 300 * scale) <= radius) {
                            // make the bunny go away from the duster
                            let directionX = mouseX - bunny.x;
                            let directionY = mouseY - bunny.y;
                            bunny.x -= directionX / 70;
                            bunny.y -= directionY / 70;

                            // spin the bunnies
                            push();
                            translate(bunny.x, bunny.y);
                            rotate(frameCount * .15);
                            image(bunnyImage, -bunnySize / 2, -bunnySize / 2, bunnySize, bunnySize);
                            pop();
                        }
                        // bunny just outside of range
                        else if (dist(bunny.x, bunny.y, mouseX, mouseY - 300 * scale) < radius + 5 * scale) {
                            // spin the bunnies
                            push();
                            translate(bunny.x, bunny.y);
                            rotate(frameCount * .15);
                            image(bunnyImage, -bunnySize / 2, -bunnySize / 2, bunnySize, bunnySize);
                            pop();

                        }
                        // bunny out of range
                        else {
                            // Go towards center
                            let directionX = (width / 2 - bunny.x) / 300;
                            let directionY = (height / 2 - bunny.y) / 300;
                            bunny.x += directionX;
                            bunny.y += directionY;
                            image(bunnyImage, bunny.x - bunnySize / 2, bunny.y - bunnySize / 2, bunnySize, bunnySize);
                        }
                        // Check if the bunny has moved out of frame
                        if (!onScreen(bunny)) {
                            dustBunnies.splice(i, 1); // Remove the bunny if it's off the screen
                        }
                    }
                    // Duster dusts
                    dusterAngle += dusterAngleDirection * dusterAngleSpeed; // calculate angle to rotate
                    if (abs(dusterAngle) > dusterMaxAngle) { // if angle is too great, flip the direction
                        dusterAngleDirection *= -1;
                    }
                    push();
                    translate(mouseX, mouseY + dusterSize * 1.75 - 100 * scale); // Adjusting the pivot point to the bottom
                    rotate(dusterAngle);
                    image(duster, -dusterSize / 3.5 - 60 * scale, -dusterSize * 3.5 - 160 * scale, dusterSize * 1.7, dusterSize * 3.5); // Position image relative to the new pivot
                    pop();
                }
                else {
                    document.getElementById("returnButton").style.display = "none";
                    // Mouse not being clicked/held
                    for (let i = dustBunnies.length - 1; i >= 0; i--) {
                        let bunny = dustBunnies[i];
                        let bunnyImage = dustBunnyImages[i];
                        let n = noise(bunny.x * noiseScale, bunny.y * noiseScale);
                        let a = TAU * n;
                        let safe;

                        // bunny follows path
                        bunny.x += cos(a);
                        bunny.y += sin(a);

                        image(bunnyImage, bunny.x - bunnySize / 2, bunny.y - bunnySize / 2, bunnySize, bunnySize);
                        image(duster, mouseX - dusterSize * 1.7 / 2, mouseY - dusterSize * 3.5 + 100 * scale, dusterSize * 1.7, dusterSize * 3.5);

                        // If bunny goes off screen, respawn at a random spot
                        if (!onScreen(bunny)) {
                            bunny.x = random(width);
                            bunny.y = random(height);
                        }
                    }
                }
            }
        }

        // Check if bunny is still on screen
        function onScreen(bunny) {
            if (bunny.x >= -bunnySize && bunny.x <= width + bunnySize && bunny.y >= 0 && bunny.y <= height) {
                return true;
            } else {
                return false;
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            var returnButton = document.getElementById('returnButton');
            returnButton.addEventListener('click', function () {
                window.location.href = 'room.html';
            });
        });

    </script>
</body>

</html>