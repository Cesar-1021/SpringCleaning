<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soda Cans</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        #returnButton {
            display: none;
            position: fixed;
            top: 80%;
            left: 50%;
            transform: translate(-50%);
            padding: 2vmin;
            font-size: 5vmin;
            color: white;
            background-color: black;
            border: none;
            border-radius: 3vmin;
            cursor: pointer;
            z-index: 1000;
        }

        #returnButton:hover {
            background-color: pink;
        }
    </style>
</head>

<body>
    <button id="returnButton">Return to Room</button>
    <script>
        var recycleCheck = localStorage.getItem('recycleCheck');
        if (recycleCheck === '-1') {
            localStorage.setItem('recycleCheck', '0');
        }

        let circus;
        let defaultSoda, sodaImg, recycle, recycleImg, cannon, cannonImg;
        let sodas = [];
        let sodasToDisplay = [];
        let index = 0;

        let gravity;
        let scale;
        let width;
        let height;

        // Preload all images
        function preload() {
            sodaImg = loadImage('sprites/enemies/soda.png');
            recycleImg = loadImage('sprites/room/recyclingBin.png');
            cannonImg = loadImage('sprites/miniGames/cannon.png');
            circus = loadImage('sprites/miniGames/circus.png');
        }

        function setup() {
            frameRate(60);

            scale = Math.min(windowWidth / circus.width, windowHeight / circus.height);

            let canvasX = (windowWidth / 2) - (circus.width / 2) * scale;
            let canvasY = (windowHeight / 2) - (circus.height / 2) * scale;
            width = circus.width * scale;
            height = circus.height * scale;

            canvas = createCanvas(width, height);
            canvas.position(canvasX, canvasY);

            calculatePositions()

            mouseX = windowWidth / 2;
            mouseY = windowHeight / 2;
        }

        function windowResized() {
            scale = Math.min(windowWidth / circus.width, windowHeight / circus.height);
            let canvasX = (windowWidth / 2) - (circus.width / 2) * scale;
            let canvasY = (windowHeight / 2) - (circus.height / 2) * scale;
            width = circus.width * scale;
            height = circus.height * scale;

            resizeCanvas(width, height);
            calculatePositions()
            canvas.position(canvasX, canvasY);
        }

        function calculatePositions() {
            gravity = 0.5 * scale;
            maxPowerX = 19 * scale;
            maxPowerY = 29 * scale;

            recycle = {
                left: width - 680 * scale,
                top: 710 * scale,
                width: recycleImg.width / 2.1 * scale,
                height: recycleImg.height / 2.1 * scale
            };
            recycle.left = width / 2 - recycle.width / 2;
            recycle.right = recycle.left + recycle.width;
            recycle.bottom = recycle.top + recycle.height;

            cannon = {
                left: width / 2,
                top: height / 2 - 90 * scale,
                width: cannonImg.width / 6 * scale,
                height: cannonImg.height / 6 * scale,
                scale: 1.005,
                count: 0
            };
            cannon.left = width / 2 - cannon.width / 2;
            cannon.top = height / 2 - cannon.height / 2;
            cannon.right = cannon.left + cannon.width;
            cannon.bottom = cannon.top + cannon.height;

            defaultSoda = {
                left: width - 680 * scale,
                top: 270 * scale,
                width: sodaImg.width / 5 * scale,
                height: sodaImg.height / 5 * scale
            };
            defaultSoda.right = defaultSoda.left + defaultSoda.width;
            defaultSoda.bottom = defaultSoda.top + defaultSoda.height;

            for (let i = 0; i < 15; i++) {
                sodas[i] = {
                    left: width - 680 * scale,
                    top: 270 * scale,
                    width: sodaImg.width / 25 * scale,
                    height: sodaImg.height / 25 * scale,
                    velocityX: 0,
                    velocityY: 0,
                    rotation: 0,
                    angle: 0.05,
                    launched: -1
                };
                sodas[i].right = sodas[i].left + sodas[i].width;
                sodas[i].bottom = sodas[i].top + sodas[i].height;
            }

            sodasToDisplay = [
                { x: 1000, y: 530, y_initial: 530, scale: 0.4, inAir: false, velocityY: 0 },
                { x: 400, y: 550, y_initial: 550, scale: 0.5, inAir: false, velocityY: 0 },
                { x: 900, y: 600, y_initial: 600, scale: 0.6, inAir: false, velocityY: 0 },
                { x: 1100, y: 625, y_initial: 625, scale: 0.7, inAir: false, velocityY: 0 },
                { x: 700, y: 650, y_initial: 650, scale: 0.8, inAir: false, velocityY: 0 },
                { x: 100, y: 700, y_initial: 700, scale: 0.9, inAir: false, velocityY: 0 },
                { x: 1200, y: 725, y_initial: 725, scale: 1.0, inAir: false, velocityY: 0 },
                { x: 900, y: 745, y_initial: 745, scale: 1.1, inAir: false, velocityY: 0 },
                { x: 400, y: 745, y_initial: 745, scale: 1.3, inAir: false, velocityY: 0 }
            ];
        }

        function draw() {
            background(circus); // set the background every frame

            if (recycleCheck <= '0') {
                image(cannonImg, cannon.left, cannon.top, cannon.width, cannon.height);
                sodasToDisplay.forEach(soda => {
                    sodaMovement(soda);
                    let check = Math.random(1);
                    if (!soda.inAir && check > 0.985) {
                        soda.velocityY = Math.random() * (-3 * scale - (-17 * scale)) + (-17 * scale);
                        soda.inAir = true;
                    }
                    image(sodaImg, soda.x * scale, soda.y * scale, defaultSoda.width * soda.scale, defaultSoda.height * soda.scale);
                });
                document.getElementById("returnButton").style.display = "block";
            } else {
                if (sodas.length < 1) {
                    image(cannonImg, cannon.left, cannon.top, cannon.width, cannon.height);
                    styledText("Cans Recycled!", width / 2, height / 2.7);
                    localStorage.setItem('recycleCheck', '2');
                    document.getElementById("returnButton").style.display = "block";
                }
                else {
                    if (cannon.width > cannonImg.width / 6 * scale && cannon.scale == 1.005) {
                        cannon.scale = 0.995;
                        cannon.count++;
                        if (cannon.count == 2) {
                            cannon.count = 0;
                            launchSoda();
                        }
                    }
                    if (cannon.width < cannonImg.width / 7.5 * scale && cannon.scale == 0.995) {
                        cannon.scale = 1.005;
                    }
                    cannon.width *= cannon.scale;
                    cannon.height *= cannon.scale;
                    cannon.left = width / 2 - cannon.width / 2;
                    cannon.top = height / 2 - cannon.height / 2;

                    image(cannonImg, cannon.left, cannon.top, cannon.width, cannon.height);

                    recycle.left = mouseX - recycle.width / 2;
                    recycle.right = recycle.left + recycle.width;
                    image(recycleImg, recycle.left, recycle.top, recycle.width, recycle.height);

                    sodas.forEach(soda => {

                        // just getting launched out of cannon - spawn on the cannon hole
                        if (soda.launched == 0) {
                            soda.width = sodaImg.width / 25 * scale;
                            soda.height = sodaImg.height / 25 * scale;
                            soda.left = width / 2 - soda.width / 2;
                            soda.top = cannon.top;
                            soda.right = soda.left + soda.width;
                            soda.bottom = soda.top + soda.height;
                            soda.launched = 1;
                        }
                        // spawned infront of cannon and need to move upwards
                        else if (soda.launched == 1) {
                            soda.velocityY = -8 * scale; // soda moves upwards
                            // Check if soda has gone past the top border
                            if (soda.bottom < -sodaImg.width / 6 * scale) {
                                soda.launched = 2;
                                soda.width = sodaImg.width / 6 * scale;
                                soda.height = sodaImg.height / 6 * scale;
                                if (Math.random() < 0.5) {
                                    soda.left = Math.random() * ((width / 2 - soda.width / 2) - soda.width) + soda.width;
                                } else {
                                    soda.left = Math.random() * ((width - soda.width) - (width / 2 + soda.width / 2)) + (width / 2 + soda.width / 2);
                                }
                                soda.right = soda.left + soda.width;
                            }
                        }
                        // soda is falling
                        else if (soda.launched == 2) {
                            soda.velocityY = 6 * scale;
                            checkLanding(soda);
                            if (soda.top > height) {
                                soda.launched = -1;
                            }
                        }

                        if (soda.launched > 0) {
                            soda.left += soda.velocityX;
                            soda.right = soda.left + soda.width;
                            soda.top += soda.velocityY;
                            soda.bottom = soda.top + soda.height;
                            soda.rotation += soda.angle;
                            push();
                            translate(soda.left + soda.width / 2, soda.top + soda.height / 2);
                            rotate(soda.rotation);
                            imageMode(CENTER);
                            image(sodaImg, 0, 0, soda.width, soda.height);
                            pop();
                        }
                    });
                }
            }
        }

        function launchSoda() {
            let soda = sodas.find(soda => soda.launched === -1);
            if (soda) {
                soda.launched = 0;
            }
        }

        function checkLanding(soda) {
            // within left and right of bin, AND bottom of soda intersects with top of bin
            if (soda.left > recycle.left && soda.right < recycle.right && soda.bottom >= recycle.top + soda.height / 4) {
                // check if middle of can has passed the recyling top before splicing
                if (soda.top + soda.height / 2 < recycle.top) {
                    current = sodas.indexOf(soda);
                    sodas.splice(current, 1);
                }
            }
        }

        function sodaMovement(soda) {
            // Update soda position based on its velocity
            soda.y += soda.velocityY;

            // Apply gravity to the soda's vertical movement
            if (soda.inAir) {
                soda.velocityY += gravity;
            }
            // Collision detection between the soda and the ground
            if (soda.y > soda.y_initial) {
                soda.velocityY = 0;
                soda.inAir = false;
            }

        }

        function styledText(string, x, y) {
            stroke(0, 0, 0);
            strokeWeight(4);
            sizeOfText = 130 * scale;
            textSize(sizeOfText);
            textStyle(BOLD);
            textAlign(CENTER);
            textFont('Papyrus');
            fill(255);
            text(string, x, y);
        }

        document.addEventListener("DOMContentLoaded", function () {
            var returnButton = document.getElementById('returnButton');
            returnButton.addEventListener('click', function () {
                window.location.href = 'room.html';
            });
        });

    </script>
</body>

</html>