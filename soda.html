<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soda Cans</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        canvas {
            display: block;
        }

        #returnButton {
            display: none;
            position: fixed;
            top: 80%;
            left: 50%;
            transform: translate(-50%);
            padding: 2vmin;
            font-size: 5vmin;
            color: white;
            background-color: black;
            border: none;
            border-radius: 3vmin;
            cursor: pointer;
            z-index: 1000;
        }

        #returnButton:hover {
            background-color: pink;
        }
    </style>
</head>

<body>
    <button id="returnButton">Return to Room</button>
    <script>
        var sodaCheck = localStorage.getItem('sodaCheck');

        let circus;
        let defaultSoda, sodaImg, recycle, recycleImg, cannon, cannonImg;
        let sodas = [];
        let index = 0;

        let gravity;
        let refScale;
        let width;
        let height;

        // Preload all images
        function preload() {
            sodaImg = loadImage('sprites/enemies/soda.png');
            recycleImg = loadImage('sprites/room/recyclingBin.png');
            cannonImg = loadImage('sprites/miniGames/cannon.png');
            circus = loadImage('sprites/miniGames/circus.png');
        }

        function setup() {
            frameRate(60);

            refScale = Math.min(windowWidth / circus.width, windowHeight / circus.height);

            let canvasX = (windowWidth / 2) - (circus.width / 2) * refScale;
            let canvasY = (windowHeight / 2) - (circus.height / 2) * refScale;
            width = circus.width * refScale;
            height = circus.height * refScale;

            canvas = createCanvas(width, height);
            canvas.position(canvasX, canvasY);

            calculatePositions()

            mouseX = windowWidth / 2;
            mouseY = windowHeight / 2;
        }

        function windowResized() {
            refScale = Math.min(windowWidth / circus.width, windowHeight / circus.height);
            let canvasX = (windowWidth / 2) - (circus.width / 2) * refScale;
            let canvasY = (windowHeight / 2) - (circus.height / 2) * refScale;
            width = circus.width * refScale;
            height = circus.height * refScale;

            resizeCanvas(width, height);
            calculatePositions()
            canvas.position(canvasX, canvasY);
        }

        function calculatePositions() {
            gravity = 0.5 * refScale;
            maxPowerX = 19 * refScale;
            maxPowerY = 29 * refScale;

            recycle = {
                left: width - 680 * refScale,
                top: 710 * refScale,
                width: recycleImg.width / 3.5 * refScale,
                height: recycleImg.height / 3.5 * refScale
            };
            recycle.left = width / 2 - recycle.width / 2;
            recycle.right = recycle.left + recycle.width;
            recycle.bottom = recycle.top + recycle.height;

            cannon = {
                left: width / 2,
                top: height / 2 - 90 * refScale,
                width: cannonImg.width / 6 * refScale,
                height: cannonImg.height / 6 * refScale,
                scale: 1.005,
                count: 0
            };
            cannon.left = width / 2 - cannon.width / 2;
            cannon.top = height / 2 - cannon.height / 2;
            cannon.right = cannon.left + cannon.width;
            cannon.bottom = cannon.top + cannon.height;

            defaultSoda = {
                left: width - 680 * refScale,
                top: 270 * refScale,
                width: sodaImg.width / 5 * refScale,
                height: sodaImg.height / 5 * refScale
            };
            defaultSoda.right = defaultSoda.left + defaultSoda.width;
            defaultSoda.bottom = defaultSoda.top + defaultSoda.height;

            for (let i = 0; i < 10; i++) {
                sodas[i] = {
                    left: width - 680 * refScale,
                    top: 270 * refScale,
                    width: sodaImg.width / 25 * refScale,
                    height: sodaImg.height / 25 * refScale,
                    velocityX: 0,
                    velocityY: 0,
                    launched: -1
                };
                sodas[i].right = sodas[i].left + sodas[i].width;
                sodas[i].bottom = sodas[i].top + sodas[i].height;
            }
        }

        function draw() {
            background(circus); // set the background every frame

            if (index > sodas.length) {
                index = 0;
            }

            if (cannon.width > cannonImg.width / 6 * refScale && cannon.scale == 1.005) {
                cannon.scale = 0.995;
                cannon.count++;
                if (cannon.count == 3) {
                    cannon.count = 0;
                    sodas[index].launched = 0;
                    index++;
                }
            }
            if (cannon.width < cannonImg.width / 7.5 * refScale && cannon.scale == 0.995) {
                cannon.scale = 1.005;
            }
            cannon.width *= cannon.scale;
            cannon.height *= cannon.scale;
            cannon.left = width / 2 - cannon.width / 2;
            cannon.top = height / 2 - cannon.height / 2;

            image(cannonImg, cannon.left, cannon.top, cannon.width, cannon.height);

            recycle.left = mouseX - recycle.width / 2;
            image(recycleImg, recycle.left, recycle.top, recycle.width, recycle.height);

            sodas.forEach(soda => {
                // just getting launched out of cannon - spawn on the cannon hole
                if (soda.launched == 0) {
                    soda.width = sodaImg.width / 25 * refScale;
                    soda.height = sodaImg.height / 25 * refScale;
                    soda.left = width / 2 - soda.width / 2;
                    soda.top = cannon.top;
                    soda.right = soda.left + soda.width;
                    soda.bottom = soda.top + soda.height;
                    soda.launched = 1;
                }

                // spawned infront of cannon and need to move upwards
                else if (soda.launched == 1) {
                    soda.velocityY = -5 * refScale; // soda moves upwards
                    // Check if soda has gone past the top border
                    if (soda.bottom < 0) {
                        soda.launched = 2;
                        soda.left = Math.random() * ((width - soda.width));
                        soda.right = soda.left + soda.width;
                        soda.top = -2 * soda.height;
                        soda.bottom = soda.top + soda.height;
                    }
                }
                else if (soda.launched == 2) {
                    soda.width = sodaImg.width / 10 * refScale;
                    soda.height = sodaImg.height / 10 * refScale;
                    soda.velocityY = 2 * refScale;
                    checkLanding(soda);
                    if (soda.top > height) {
                        soda.launched = 0;
                    }
                }

                soda.left += soda.velocityX;
                soda.right = soda.left + soda.width;
                soda.top += soda.velocityY;
                soda.bottom = soda.top + soda.height;
                if (soda.launched > 0) {
                    image(sodaImg, soda.left, soda.top, soda.width, soda.height);
                }
            });
        }

        function checkLanding(soda) {
            // within right and left 
            if (soda.right - soda.width / 2 > recycle.left && soda.left + soda.width / 2 < recycle.right) {
                // Check if soda lands in recycle
                if (soda.bottom - soda.height / 2 > recycle.top && // half of soda inside recycle
                    soda.bottom < recycle.bottom &&
                    soda.velocityY > 0) { // checks if the soda is falling down into the recycle
                    sodas.splice(0, 1);
                }
            }
        }


        function styledText(string, x, y) {
            stroke(0, 0, 0);
            strokeWeight(5);
            sizeOfText = 130 * refScale;
            textSize(sizeOfText);
            textStyle(BOLD);
            textAlign(CENTER);
            textFont('Papyrus');
            fill(255);
            text(string, x, y);
        }

    </script>
</body>

</html>